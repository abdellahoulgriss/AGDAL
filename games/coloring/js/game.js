const COLORS = [    '#FF6B6B', '#FF8E72', '#FFAF64', '#FFE66D', '#C7F464', '#4ECDC4',    '#45B7D1', '#2C3E50', '#a29bfe', '#e84393', '#6c5ce7', '#00b894',    '#55E6C1', '#F8EFBA', '#58B19F', '#2C3A47', '#D6A2E8', '#ffffff'];const CANVAS_WIDTH = 800;const CANVAS_HEIGHT = 800;const DRAWINGS = [    { name: "Sun", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle cx="100" cy="100" r="50" stroke="black" stroke-width="3" fill="none" /> <path d="M100 20 L100 40 M100 160 L100 180 M20 100 L40 100 M160 100 L180 100 M45 45 L60 60 M140 140 L155 155 M45 155 L60 140 M140 60 L155 45" stroke="black" stroke-width="3" /></svg>' },    { name: "Moon", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><path d="M100 20 A60 60 0 1 0 100 180 A50 50 0 1 1 100 20" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Star", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><polygon points="100,20 125,80 190,80 140,120 155,180 100,145 45,180 60,120 10,80 75,80" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Flower", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle cx="100" cy="100" r="20" stroke="black" stroke-width="3" fill="none" /> <circle cx="100" cy="60" r="20" stroke="black" stroke-width="3" fill="none" /> <circle cx="140" cy="100" r="20" stroke="black" stroke-width="3" fill="none" /> <circle cx="100" cy="140" r="20" stroke="black" stroke-width="3" fill="none" /> <circle cx="60" cy="100" r="20" stroke="black" stroke-width="3" fill="none" /> <path d="M100 140 L100 200" stroke="black" stroke-width="4" /></svg>' },    { name: "Tree", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect x="85" y="140" width="30" height="60" stroke="black" stroke-width="3" fill="none" /> <circle cx="100" cy="100" r="50" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Apple", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle cx="90" cy="100" r="40" stroke="black" stroke-width="3" fill="none" /> <circle cx="110" cy="100" r="40" stroke="black" stroke-width="3" fill="none" /> <path d="M100 60 L100 40" stroke="black" stroke-width="4" /></svg>' },    { name: "Banana", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><path d="M50 150 Q100 200 150 150 Q120 120 50 150" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Car", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect x="40" y="100" width="120" height="40" stroke="black" stroke-width="3" fill="none" /> <path d="M60 100 L70 70 L130 70 L140 100" stroke="black" stroke-width="3" fill="none" /> <circle cx="60" cy="140" r="15" stroke="black" stroke-width="3" fill="none" /> <circle cx="140" cy="140" r="15" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "House", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect x="50" y="100" width="100" height="80" stroke="black" stroke-width="3" fill="none" /> <polygon points="50,100 100,50 150,100" stroke="black" stroke-width="3" fill="none" /> <rect x="90" y="140" width="20" height="40" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Boat", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><path d="M50 120 L150 120 L130 160 L70 160 Z" stroke="black" stroke-width="3" fill="none" /> <path d="M100 120 L100 40 L140 100 Z" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Butterfly", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><ellipse cx="100" cy="100" rx="10" ry="40" stroke="black" stroke-width="3" fill="none" /> <ellipse cx="70" cy="80" rx="20" ry="20" stroke="black" stroke-width="3" fill="none" /> <ellipse cx="130" cy="80" rx="20" ry="20" stroke="black" stroke-width="3" fill="none" /> <ellipse cx="70" cy="120" rx="15" ry="15" stroke="black" stroke-width="3" fill="none" /> <ellipse cx="130" cy="120" rx="15" ry="15" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Fish", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><ellipse cx="100" cy="100" rx="50" ry="30" stroke="black" stroke-width="3" fill="none" /> <polygon points="150,100 180,80 180,120" stroke="black" stroke-width="3" fill="none" /> <circle cx="70" cy="90" r="3" fill="black" /></svg>' },    { name: "Cat", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle cx="100" cy="100" r="40" stroke="black" stroke-width="3" fill="none" /> <polygon points="70,70 60,40 90,60" stroke="black" stroke-width="3" fill="none" /> <polygon points="130,70 140,40 110,60" stroke="black" stroke-width="3" fill="none" /> <circle cx="85" cy="90" r="3" fill="black" /> <circle cx="115" cy="90" r="3" fill="black" /></svg>' },    { name: "Dog", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><ellipse cx="100" cy="100" rx="40" ry="35" stroke="black" stroke-width="3" fill="none" /> <ellipse cx="60" cy="100" rx="10" ry="20" stroke="black" stroke-width="3" fill="none" /> <ellipse cx="140" cy="100" rx="10" ry="20" stroke="black" stroke-width="3" fill="none" /> <circle cx="90" cy="90" r="3" fill="black" /> <circle cx="110" cy="90" r="3" fill="black" /></svg>' },    { name: "Bear", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle cx="100" cy="100" r="40" stroke="black" stroke-width="3" fill="none" /> <circle cx="65" cy="70" r="10" stroke="black" stroke-width="3" fill="none" /> <circle cx="135" cy="70" r="10" stroke="black" stroke-width="3" fill="none" /> <circle cx="90" cy="90" r="3" fill="black" /> <circle cx="110" cy="90" r="3" fill="black" /></svg>' },    { name: "Heart", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><path d="M100 180 C40 120 40 60 100 80 C160 60 160 120 100 180" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Diamond", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><polygon points="100,40 160,100 100,160 40,100" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Cloud", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><path d="M60 100 A20 20 0 1 1 80 80 A30 30 0 1 1 130 80 A20 20 0 1 1 140 100 L60 100" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Umbrella", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><path d="M40 100 Q100 20 160 100" stroke="black" stroke-width="3" fill="none" /> <path d="M100 100 L100 160 Q100 180 80 180" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Ball", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle cx="100" cy="100" r="40" stroke="black" stroke-width="3" fill="none" /> <path d="M60 100 Q100 140 140 100" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Kite", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><polygon points="100,40 140,80 100,160 60,80" stroke="black" stroke-width="3" fill="none" /> <path d="M60 80 L140 80 M100 40 L100 160" stroke="black" stroke-width="3" /></svg>' },    { name: "Balloon", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><ellipse cx="100" cy="80" rx="30" ry="40" stroke="black" stroke-width="3" fill="none" /> <path d="M100 120 L100 160" stroke="black" stroke-width="3" /></svg>' },    { name: "Icecream", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><path d="M80 80 L100 160 L120 80" stroke="black" stroke-width="3" fill="none" /> <circle cx="100" cy="80" r="20" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Cupcake", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><path d="M70 100 L80 140 L120 140 L130 100 Z" stroke="black" stroke-width="3" fill="none" /> <path d="M70 100 Q100 60 130 100" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Pencil", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect x="90" y="60" width="20" height="80" stroke="black" stroke-width="3" fill="none" /> <polygon points="90,140 100,160 110,140" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Book", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect x="60" y="80" width="80" height="60" stroke="black" stroke-width="3" fill="none" /> <line x1="100" y1="80" x2="100" y2="140" stroke="black" stroke-width="3" /></svg>' },    { name: "Rocket", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect x="85" y="60" width="30" height="60" stroke="black" stroke-width="3" fill="none" /> <polygon points="85,60 100,30 115,60" stroke="black" stroke-width="3" fill="none" /> <polygon points="85,120 70,140 85,140" stroke="black" stroke-width="3" fill="none" /> <polygon points="115,120 130,140 115,140" stroke="black" stroke-width="3" fill="none" /></svg>' },    { name: "Robot", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><rect x="80" y="60" width="40" height="40" stroke="black" stroke-width="3" fill="none" /> <rect x="70" y="100" width="60" height="60" stroke="black" stroke-width="3" fill="none" /> <line x1="70" y1="120" x2="50" y2="140" stroke="black" stroke-width="3" /> <line x1="130" y1="120" x2="150" y2="140" stroke="black" stroke-width="3" /></svg>' },    { name: "Ghost", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><path d="M70 160 L70 80 Q100 40 130 80 L130 160 Q115 140 100 160 Q85 140 70 160" stroke="black" stroke-width="3" fill="none" /> <circle cx="90" cy="90" r="3" fill="black" /> <circle cx="110" cy="90" r="3" fill="black" /></svg>' },    { name: "Smiley", svg: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle cx="100" cy="100" r="50" stroke="black" stroke-width="3" fill="none" /> <circle cx="85" cy="90" r="5" fill="black" /> <circle cx="115" cy="90" r="5" fill="black" /> <path d="M85 120 Q100 135 115 120" stroke="black" stroke-width="3" fill="none" /></svg>' }];let currentTool = 'brush';let currentColor = '#FF6B6B';let brushSize = 5;let isDrawing = false;let history = [];let historyStep = -1;const canvas = document.getElementById('coloring-canvas');const ctx = canvas.getContext('2d', { willReadFrequently: true });const outlineCanvas = document.getElementById('outline-canvas');const outlineCtx = outlineCanvas.getContext('2d', { willReadFrequently: true });const paletteContainer = document.getElementById('color-palette');const galleryGrid = document.getElementById('gallery-grid');function init() {    canvas.width = CANVAS_WIDTH;    canvas.height = CANVAS_HEIGHT;    ctx.fillStyle = '#ffffff';    ctx.fillRect(0, 0, canvas.width, canvas.height);    outlineCanvas.width = CANVAS_WIDTH;    outlineCanvas.height = CANVAS_HEIGHT;    saveState();    renderPalette();    loadGallery();        outlineCanvas.addEventListener('mousedown', startDrawing);    outlineCanvas.addEventListener('mousemove', draw);    outlineCanvas.addEventListener('mouseup', stopDrawing);    outlineCanvas.addEventListener('mouseout', stopDrawing);    outlineCanvas.addEventListener('touchstart', handleTouchStart, { passive: false });    outlineCanvas.addEventListener('touchmove', handleTouchMove, { passive: false });    outlineCanvas.addEventListener('touchend', stopDrawing);}function setBrushSize(size) {    brushSize = size;    document.querySelectorAll('.brush-btn').forEach(btn => {        btn.classList.toggle('active', parseInt(btn.dataset.size) === size);    });}function activateTool(tool) {    currentTool = tool;    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));    document.getElementById(`btn-${tool}`).classList.add('active');    if (tool === 'eraser') outlineCanvas.style.cursor = 'cell';    else if (tool === 'fill') outlineCanvas.style.cursor = 'alias';    else outlineCanvas.style.cursor = 'crosshair';}function setColor(color) {    currentColor = color;    if (currentTool === 'eraser') activateTool('brush');    document.querySelectorAll('.color-swatch').forEach(swatch => {        swatch.classList.toggle('active', swatch.dataset.color === color);    });}function startDrawing(e) {    try {        const rect = outlineCanvas.getBoundingClientRect();        const scaleX = outlineCanvas.width / rect.width;        const scaleY = outlineCanvas.height / rect.height;        const x = Math.floor((e.clientX - rect.left) * scaleX);        const y = Math.floor((e.clientY - rect.top) * scaleY);        if (currentTool === 'fill') {            floodFill(x, y, currentColor);            return;        }        isDrawing = true;        ctx.beginPath();        ctx.moveTo(x, y);        draw(e);    } catch (err) {        console.error("Drawing error:", err);    }}function draw(e) {    if (!isDrawing) return;    const rect = outlineCanvas.getBoundingClientRect();    const scaleX = outlineCanvas.width / rect.width;    const scaleY = outlineCanvas.height / rect.height;    const x = (e.clientX - rect.left) * scaleX;    const y = (e.clientY - rect.top) * scaleY;    ctx.lineCap = 'round';    ctx.lineJoin = 'round';    ctx.lineWidth = brushSize;    ctx.strokeStyle = currentTool === 'eraser' ? '#ffffff' : currentColor;    ctx.lineTo(x, y);    ctx.stroke();    ctx.beginPath();    ctx.moveTo(x, y);}function stopDrawing() {    if (isDrawing) {        isDrawing = false;        ctx.beginPath();        saveState();    }}function floodFill(startX, startY, fillColor) {    try {        const colorData = ctx.getImageData(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);        const outlineData = outlineCtx.getImageData(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);        const r = parseInt(fillColor.slice(1, 3), 16);        const g = parseInt(fillColor.slice(3, 5), 16);        const b = parseInt(fillColor.slice(5, 7), 16);        const a = 255;        const startPos = (startY * CANVAS_WIDTH + startX) * 4;        const startR = colorData.data[startPos];        const startG = colorData.data[startPos + 1];        const startB = colorData.data[startPos + 2];        const startA = colorData.data[startPos + 3];        if (startR === r && startG === g && startB === b && startA === a) return;        const stack = [[startX, startY]];        while (stack.length) {            const [curX, curY] = stack.pop();            const pos = (curY * CANVAS_WIDTH + curX) * 4;            if (curX < 0 || curX >= CANVAS_WIDTH || curY < 0 || curY >= CANVAS_HEIGHT) continue;                        if (outlineData.data[pos + 3] > 100) continue;                        if (colorData.data[pos] !== startR ||                colorData.data[pos + 1] !== startG ||                colorData.data[pos + 2] !== startB) continue;                        colorData.data[pos] = r;            colorData.data[pos + 1] = g;            colorData.data[pos + 2] = b;            colorData.data[pos + 3] = a;            stack.push([curX + 1, curY]);            stack.push([curX - 1, curY]);            stack.push([curX, curY + 1]);            stack.push([curX, curY - 1]);        }        ctx.putImageData(colorData, 0, 0);        saveState();    } catch (e) {        console.error("Flood Fill failed:", e);                if (e.name === 'SecurityError') {            ctx.fillStyle = fillColor;            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);            saveState();        }    }}function handleTouchStart(e) {    if (e.touches.length > 1) return;     e.preventDefault();    const touch = e.touches[0];    const mouseEvent = new MouseEvent("mousedown", { clientX: touch.clientX, clientY: touch.clientY });    outlineCanvas.dispatchEvent(mouseEvent);}function handleTouchMove(e) {    if (e.touches.length > 1) return;    e.preventDefault();    const touch = e.touches[0];    const mouseEvent = new MouseEvent("mousemove", { clientX: touch.clientX, clientY: touch.clientY });    outlineCanvas.dispatchEvent(mouseEvent);}function saveState() {    historyStep++;    if (historyStep < history.length) history.length = historyStep;    try {        history.push(canvas.toDataURL());    } catch (e) {                console.error("History save failed:", e);    }    if (history.length > 10) { history.shift(); historyStep--; }}function undo() {    if (historyStep > 0) {        historyStep--;        const img = new Image();        img.src = history[historyStep];        img.onload = () => {            ctx.clearRect(0, 0, canvas.width, canvas.height);            ctx.drawImage(img, 0, 0);        };    }}function clearCanvas() {    if (confirm('هل أنت متأكد من مسح كل شيء؟')) {        ctx.fillStyle = '#ffffff';        ctx.fillRect(0, 0, canvas.width, canvas.height);        saveState();    }}function renderPalette() {    paletteContainer.innerHTML = COLORS.map(color => `        <div class="color-swatch ${color === currentColor ? 'active' : ''}"              style="background-color: ${color}" data-color="${color}" onclick="setColor('${color}')">        </div>`).join('');}function loadGallery() {    let imagesHtml = '';    DRAWINGS.forEach((draw, i) => {                const svgBlob = new Blob([draw.svg], { type: 'image/svg+xml' });        const url = URL.createObjectURL(svgBlob);        imagesHtml += `<div class="gallery-item" onclick="loadSvg(${i})">            <img src="${url}" alt="${draw.name}" loading="lazy">        </div>`;    });    galleryGrid.innerHTML = imagesHtml;}function openGallery() { document.getElementById('gallery-modal').classList.add('active'); }function closeGallery() { document.getElementById('gallery-modal').classList.remove('active'); }function loadSvg(index) {    const drawing = DRAWINGS[index];    const img = new Image();        const svgData = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(drawing.svg);    img.src = svgData;    img.onload = () => {        outlineCtx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);        outlineCtx.drawImage(img, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);        ctx.fillStyle = '#ffffff';        ctx.fillRect(0, 0, canvas.width, canvas.height);        history = [];        historyStep = -1;        saveState();        closeGallery();    };}function downloadImage() {    try {        const tempCanvas = document.createElement('canvas');        tempCanvas.width = CANVAS_WIDTH;        tempCanvas.height = CANVAS_HEIGHT;        const tCtx = tempCanvas.getContext('2d');        tCtx.drawImage(canvas, 0, 0);         tCtx.drawImage(outlineCanvas, 0, 0);         const link = document.createElement('a');        link.download = `coloring-masterpiece-${Date.now()}.png`;        link.href = tempCanvas.toDataURL('image/png');        document.body.appendChild(link);        link.click();        document.body.removeChild(link);    } catch (e) {        alert('Could not save image (Browser restriction).');        console.error(e);    }}function goBack() {    if (confirm('هل تريد الخروج؟')) window.location.href = '../../index.html';}init();